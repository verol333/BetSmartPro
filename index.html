<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BetSmart Pro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Même style CSS que précédemment -->
    <style>
        /* Votre CSS reste identique */
    </style>
</head>
<body>
    <div class="welcome-card" id="welcome-card">
        <div class="telegram-logo">
            <i class="fab fa-telegram-plane"></i>
        </div>
        <h1 class="welcome-title">Bienvenue sur BetSmart Pro</h1>
        <p class="welcome-subtitle">Rejoignez notre canal Telegram pour accéder à des prédictions exclusives et des analyses détaillées</p>
        
        <a href="https://t.me/alvecapital1" target="_blank" class="join-button">
            <i class="fab fa-telegram-plane"></i> Rejoindre le canal
        </a>
        
        <button id="verify-btn" class="verify-button" onclick="verifySubscription()">
            <span id="spinner" class="spinner"></span>
            Vérifier l'abonnement
        </button>

        <div id="status-message" class="status-message"></div>
        
        <div class="bot-name">@BetSmartPro_bot</div>
    </div>

    <div id="main-app" style="display: none;">
        <!-- Contenu principal de l'application -->
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // Fonction de debug
        function logDebug(message, data = '') {
            console.log(`[DEBUG] ${message}`, data);
        }

        async function verifySubscription() {
            const verifyBtn = document.getElementById('verify-btn');
            const spinner = document.getElementById('spinner');
            const statusMsg = document.getElementById('status-message');

            // Log initial
            logDebug('Début de la vérification');
            logDebug('User ID:', tg.initDataUnsafe.user.id);

            // Désactive le bouton et affiche le spinner
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="spinner"></span>Vérification...';
            statusMsg.style.display = 'none';

            try {
                logDebug('Envoi de la requête à l\'API Telegram');
                
                const requestBody = {
                    chat_id: '@alvecapital1',
                    user_id: tg.initDataUnsafe.user.id
                };
                
                logDebug('Request body:', requestBody);

                const response = await fetch('https://api.telegram.org/bot6526990595:AAGqyrKD4F0wKpf-_lZgz5Lw23VfTykPTnc/getChatMember', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                logDebug('Réponse API:', data);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                if (data.ok) {
                    const memberStatus = data.result.status;
                    logDebug('Status membre:', memberStatus);

                    if (['member', 'administrator', 'creator'].includes(memberStatus)) {
                        // Succès
                        statusMsg.textContent = 'Vérification réussie ! Redirection en cours...';
                        statusMsg.className = 'status-message success';
                        statusMsg.style.display = 'block';
                        
                        setTimeout(() => {
                            document.getElementById('welcome-card').style.display = 'none';
                            document.getElementById('main-app').style.display = 'block';
                            logDebug('Redirection vers l\'application principale');
                        }, 1500);
                    } else {
                        // Non membre
                        statusMsg.textContent = 'Veuillez vous abonner au canal pour accéder à l\'application';
                        statusMsg.className = 'status-message error';
                        statusMsg.style.display = 'block';
                        logDebug('Utilisateur non membre');
                    }
                } else {
                    throw new Error('Réponse API non valide');
                }
            } catch (error) {
                logDebug('Erreur:', error.message);
                statusMsg.textContent = 'Une erreur est survenue. Veuillez réessayer.';
                statusMsg.className = 'status-message error';
                statusMsg.style.display = 'block';
            } finally {
                // Réactive le bouton et restaure son texte
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = 'Vérifier l\'abonnement';
                logDebug('Fin de la vérification');
            }
        }

        // Fonction pour vérifier périodiquement le statut
        function startPeriodicCheck() {
            logDebug('Démarrage de la vérification périodique');
            verifySubscription();
            // Vérifie toutes les 30 secondes
            setInterval(verifySubscription, 30000);
        }

        // Démarrage de l'application
        document.addEventListener('DOMContentLoaded', () => {
            logDebug('Application initialisée');
            // Première vérification après 1 seconde
            setTimeout(startPeriodicCheck, 1000);
        });

        // Telegram WebApp ready
        tg.ready();
    </script>
</body>
</html>
